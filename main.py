import os
import logging
import requests
import time
import json
import base64
from flask import Flask, request
from google import genai
from google.genai import types
from io import BytesIO

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

BOT_TOKEN = os.environ.get('BOT_TOKEN')
GEMINI_API_KEY = "AIzaSyCJXtPnJsFlEilLgJEZzCqtN3klDZrotWE"

def setup_webhook():
    try:
        RENDER_URL = "https://telegram-bot-kie.onrender.com"
        webhook_url = f"{RENDER_URL}/webhook"
        
        response = requests.post(
            f"https://api.telegram.org/bot{BOT_TOKEN}/setWebhook",
            json={"url": webhook_url}
        )
        
        if response.status_code == 200:
            logger.info(f"‚úÖ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        else:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {response.text}")
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {e}")

setup_webhook()

def generate_image_imagen3(prompt):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Imagen 3 –∏—Å–ø–æ–ª—å–∑—É—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É"""
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
        client = genai.Client(api_key=GEMINI_API_KEY)
        
        logger.info(f"üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Imagen 3...")
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        response = client.models.generate_images(
            model='imagen-3.0-generate-002',
            prompt=prompt,
            config=types.GenerateImagesConfig(
                number_of_images=1,
                aspect_ratio='1:1'
            )
        )
        
        logger.info(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ")
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 –¥–ª—è Telegram
        if response.generated_images:
            image_bytes = response.generated_images[0].image.image_bytes
            image_base64 = base64.b64encode(image_bytes).decode('utf-8')
            return f"data:image/png;base64,{image_base64}"
        else:
            logger.error("‚ùå –ù–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
            return None
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Imagen 3: {e}")
        return None

def test_gemini_text():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"""
    try:
        client = genai.Client(api_key=GEMINI_API_KEY)
        
        response = client.models.generate_content(
            model="gemini-2.0-flash",
            contents="–û—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: —Ä–∞–±–æ—Ç–∞–µ—Ç"
        )
        
        logger.info(f"‚úÖ –¢–µ–∫—Å—Ç–æ–≤–∞—è –º–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç: {response.text}")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå –¢–µ–∫—Å—Ç–æ–≤–∞—è –º–æ–¥–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: {e}")
        return False

def process_message(chat_id, text):
    logger.info(f"üîß –û–±—Ä–∞–±–æ—Ç–∫–∞: {text}")
    
    try:
        if text == '/start':
            send_message(chat_id, 
                "üé® –ë–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!\n\n"
                "‚ú® –ò—Å–ø–æ–ª—å–∑—É–µ–º Google Imagen 3\n"
                "üìù –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏\n\n"
                "–ö–æ–º–∞–Ω–¥—ã:\n"
                "/generate - —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n" 
                "/help - –ø–æ–º–æ—â—å\n"
                "/test - —Ç–µ—Å—Ç API"
            )
            return
            
        if text == '/test':
            send_message(chat_id, "üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google AI...")
            if test_gemini_text():
                send_message(chat_id, "‚úÖ API –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç! –ú–æ–∂–µ–º –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è üöÄ")
            else:
                send_message(chat_id, "‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º. –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.")
            return
            
        if text in ['/help', '/generate']:
            send_message(chat_id, 
                "üìù –ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã:\n"
                "‚Ä¢ '–ö–æ—Ç –≤ –∫–æ—Å–º–æ—Å–µ –≤ —Å–∫–∞—Ñ–∞–Ω–¥—Ä–µ'\n" 
                "‚Ä¢ '–§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ–¥ –Ω–æ—á—å—é'\n"
                "‚Ä¢ '–ó–∞–∫–∞—Ç –Ω–∞ —Ç—Ä–æ–ø–∏—á–µ—Å–∫–æ–º –ø–ª—è–∂–µ'\n"
                "‚Ä¢ '–†–æ–±–æ—Ç —á–∏—Ç–∞–µ—Ç –∫–Ω–∏–≥—É –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ'"
            )
            return
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        logger.info(f"üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è: {text}")
        send_message(chat_id, f"üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é: '{text}'...\n–ò—Å–ø–æ–ª—å–∑—É—é Google Imagen 3 üöÄ")
        
        image_data = generate_image_imagen3(text)
        
        if image_data:
            logger.info(f"‚úÖ –£—Å–ø–µ—Ö! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
            send_telegram_photo(chat_id, image_data, text)
        else:
            logger.error("‚ùå –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å")
            send_message(chat_id, 
                "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏\n\n"
                "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                "‚Ä¢ –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∑–∞–ø—Ä–æ—Å\n"
                "‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º\n"
                "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π /test –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏\n"
                "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å"
            )
            
    except Exception as e:
        logger.error(f"üí• –û—à–∏–±–∫–∞: {e}")
        send_message(chat_id, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")

def send_telegram_photo(chat_id, image_data, prompt):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –≤ Telegram"""
    try:
        if image_data.startswith('data:image'):
            # –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–∞–π–ª
            image_bytes = base64.b64decode(image_data.split(',')[1])
            
            response = requests.post(
                f"https://api.telegram.org/bot{BOT_TOKEN}/sendPhoto",
                data={
                    'chat_id': chat_id,
                    'caption': f"üé® Google Imagen 3: '{prompt}'"
                },
                files={
                    'photo': ('image.png', image_bytes, 'image/png')
                },
                timeout=30
            )
            
            if response.status_code == 200:
                logger.info(f"‚úÖ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
            else:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: {response.text}")
                send_message(chat_id, f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏")
                
        else:
            # –ï—Å–ª–∏ —ç—Ç–æ URL
            response = requests.post(
                f"https://api.telegram.org/bot{BOT_TOKEN}/sendPhoto",
                json={
                    'chat_id': chat_id,
                    'photo': image_data,
                    'caption': f"üé® Google Imagen 3: '{prompt}'"
                },
                timeout=30
            )
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: {e}")
        send_message(chat_id, f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏")

def send_message(chat_id, text):
    try:
        response = requests.post(
            f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
            json={"chat_id": chat_id, "text": text}
        )
        if response.status_code != 200:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: {response.text}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

@app.route('/')
def home():
    return "–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ Google Imagen 3"

@app.route('/webhook', methods=['POST'])
def webhook():
    if request.method == 'POST':
        try:
            data = request.get_json()
            
            if 'message' in data:
                chat_id = data['message']['chat']['id']
                text = data['message']['text']
                logger.info(f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: {text}")
                
                process_message(chat_id, text)
            
            return 'ok'
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ webhook: {e}")
            return 'error'

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
